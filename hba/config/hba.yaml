# =============================================================================
# HBA (Hierarchical Bundle Adjustment) Node 配置文件
# =============================================================================
# 功能：一致性地图优化，用于离线优化已建好的地图
# 工作流程：
#   1. 加载PGO保存的分块点云和位姿
#   2. 执行分层BA优化
#   3. 输出优化后的位姿
# 适用场景：
#   - 小场景使用BALM
#   - 大场景使用HBA
# 输入：
#   - Service: /hba/refine_map (触发优化)
# 输出：
#   - Topic: map_points (优化后的地图点云)
#   - Service: /hba/save_poses (保存优化后的位姿)
# =============================================================================

# -----------------------------------------------------------------------------
# 点云预处理 (Point Cloud Preprocessing)
# -----------------------------------------------------------------------------
scan_resolution: 0.1               # 输入点云的体素滤波分辨率(m)
                                   # 用于减少点云数量加速优化

# -----------------------------------------------------------------------------
# 滑窗配置 (Sliding Window Configuration)
# -----------------------------------------------------------------------------
window_size: 20                    # 滑窗大小（关键帧数）
                                   # 每次优化处理的关键帧数量
stride: 10                         # 滑窗步进（关键帧数）
                                   # 滑窗每次移动的帧数

# -----------------------------------------------------------------------------
# 体素配置 (Voxel Configuration)
# -----------------------------------------------------------------------------
voxel_size: 0.5                    # 体素大小(m)
                                   # 用于将点云分组进行平面拟合
min_point_num: 10                  # 体素内最小点数
                                   # 少于此数的体素不参与优化

# -----------------------------------------------------------------------------
# BA优化配置 (Bundle Adjustment Configuration)
# -----------------------------------------------------------------------------
max_layer: 3                       # 最大层数（HBA分层数）
                                   # 层数越多优化越精细但耗时增加
plane_thresh: 0.01                 # 平面拟合阈值(m)
                                   # 点到平面距离小于此值认为是内点
ba_max_iter: 10                    # 单层BA最大迭代次数
hba_iter: 5                        # HBA总迭代次数
                                   # 整个优化流程重复的次数
down_sample: 0.1                   # 输出地图降采样分辨率(m)

# =============================================================================
# 使用说明
# =============================================================================
# 前置条件：需要PGO保存地图时设置save_patches=true
#
# 1. 启动: ros2 launch hba hba_launch.py
#
# 2. 触发优化:
#    ros2 service call /hba/refine_map interface/srv/RefineMap \
#      "{maps_path: '/path/to/maps'}"
#    - maps_path: 包含patches/和poses.txt的目录
#
# 3. 保存优化后的位姿:
#    ros2 service call /hba/save_poses interface/srv/SavePoses \
#      "{file_path: '/path/to/optimized_poses.txt'}"
# =============================================================================
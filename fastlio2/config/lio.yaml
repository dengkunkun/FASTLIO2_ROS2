# =============================================================================
# FAST-LIO2 LIO Node 配置文件
# =============================================================================
# 功能：激光惯性里程计(LIO)，融合IMU和LiDAR数据进行实时定位和建图
# 输出：
#   - TF: world_frame → body_frame (里程计变换)
#   - Topic: body_cloud, world_cloud, lio_odom, lio_path
# =============================================================================

# -----------------------------------------------------------------------------
# 话题配置 (Topic Configuration)
# -----------------------------------------------------------------------------
imu_topic: /livox/imu              # IMU数据话题，需要是sensor_msgs/Imu类型
lidar_topic: /livox/lidar          # LiDAR数据话题，需要是livox_ros_driver2/CustomMsg类型

# -----------------------------------------------------------------------------
# 坐标系配置 (Frame Configuration)
# -----------------------------------------------------------------------------
body_frame: body                   # 机器人body坐标系名称，LiDAR安装位置
world_frame: camera_init           # 世界坐标系名称（里程计起点），也称为local_frame
                                   # 注意：这是FAST-LIO2的局部坐标系，启动时为原点


# -----------------------------------------------------------------------------
# 调试配置 (Debug Configuration)
# -----------------------------------------------------------------------------
print_time_cost: false             # 是否打印每帧处理耗时，用于性能分析

# -----------------------------------------------------------------------------
# LiDAR点云预处理配置 (LiDAR Preprocessing)
# -----------------------------------------------------------------------------
lidar_filter_num: 6                # 点云降采样因子，每N个点取1个，减少计算量
                                   # 值越大处理越快但精度下降，建议4-8
lidar_min_range: 0.5               # 最小有效距离(m)，过滤近处噪点（如机器人本体）
lidar_max_range: 30.0              # 最大有效距离(m)，过滤远处稀疏/噪点

# -----------------------------------------------------------------------------
# 地图分辨率配置 (Map Resolution)
# -----------------------------------------------------------------------------
scan_resolution: 0.15              # 当前扫描点云的体素滤波分辨率(m)
                                   # 值越小精度越高但计算量增大
map_resolution: 0.3                # 增量式地图的体素分辨率(m)
                                   # 值越小地图越精细但内存占用增大

# -----------------------------------------------------------------------------
# ikd-Tree地图管理配置 (ikd-Tree Map Management)
# -----------------------------------------------------------------------------
cube_len: 300                      # 地图立方体边长(m)，定义地图的有效范围
                                   # 超出范围的点会被裁剪
det_range: 60                      # 检测范围(m)，用于动态地图裁剪
move_thresh: 1.5                   # 地图移动阈值(m)，当机器人移动超过此距离时更新地图边界

# -----------------------------------------------------------------------------
# 定位模式配置 (Localization Mode)
# -----------------------------------------------------------------------------
freeze_map: false                  # 是否冻结ikd-Tree地图（不添加新扫描点）
                                   # true: 定位模式，仅用已加载地图进行点云匹配，不会向ikd-Tree加入新点
                                   # false: 建图模式，正常增量式地图更新
                                   # 定位模式下新扫描点不会污染已加载的地图，避免里程计漂移导致地图退化

localization_mode: true            # 定位模式安全网（推荐在定位场景下开启）
                                   # true: IESKF初始化完成后自动冻结ikd-Tree（延迟 localization_freeze_delay_frames 帧）
                                   #       即使 auto_relocalize 未调用 reset_mapping，也能防止地图退化
                                   #       注意：仅冻结地图，不加载先验PCD（需配合 reset_mapping 获得最佳效果）
                                   # false: 不自动冻结，仅依赖 reset_mapping 或 freeze_map 配置
localization_freeze_delay_frames: 1000  # 定位模式延迟冻结帧数，约 100 秒 @10Hz
                                        # 足够时间积累丰富的ikd-Tree点云（~5-6万点）
                                        # 点云越丰富，后续ICP匹配质量越好
                                        # (旧值200帧仅~1.3万点，导致ICP长时间运行后匹配退化)

# -----------------------------------------------------------------------------
# IMU噪声参数 (IMU Noise Parameters) - 卡尔曼滤波协方差
# -----------------------------------------------------------------------------
# 这些参数需要根据具体IMU标定获得，影响滤波器的信任程度
na: 0.01                           # 加速度计噪声密度 (m/s^2/√Hz)
                                   # 值越大表示加速度计越不可信
ng: 0.01                           # 陀螺仪噪声密度 (rad/s/√Hz)
                                   # 值越大表示陀螺仪越不可信
nba: 0.0001                        # 加速度计偏置随机游走 (m/s^3/√Hz)
nbg: 0.0001                        # 陀螺仪偏置随机游走 (rad/s^2/√Hz)

# -----------------------------------------------------------------------------
# 滤波器配置 (Filter Configuration)
# -----------------------------------------------------------------------------
imu_init_num: 20                   # IMU初始化帧数，用于估计初始偏置和重力方向
                                   # 初始化期间机器人需保持静止
near_search_num: 5                 # 最近邻搜索点数，用于点到面残差计算
                                   # 值越大约束越强但计算量增大
ieskf_max_iter: 5                  # 迭代扩展卡尔曼滤波最大迭代次数
                                   # 值越大精度越高但耗时增加

# -----------------------------------------------------------------------------
# 外参估计配置 (Extrinsic Estimation)
# -----------------------------------------------------------------------------
gravity_align: true                # 是否进行重力对齐
                                   # true: 自动估计重力方向，使z轴对齐重力
                                   # false: 假设IMU水平安装
esti_il: false                     # 是否在线估计IMU-LiDAR外参
                                   # true: 运行时优化外参（需要良好初值）
                                   # false: 使用下面配置的固定外参

# -----------------------------------------------------------------------------
# IMU-LiDAR外参 (IMU-LiDAR Extrinsic) - 从IMU坐标系到LiDAR坐标系的变换
# -----------------------------------------------------------------------------
# 对于MID360一体机，IMU和LiDAR坐标系基本对齐，r_il为单位矩阵
# 旋转矩阵r_il: [r11,r12,r13, r21,r22,r23, r31,r32,r33] 按行展开
r_il: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]

# 平移向量t_il: [x, y, z] IMU到LiDAR的平移(m)
# 这是Livox MID360的默认值，IMU相对LiDAR的位置偏移
t_il: [-0.011, -0.02329, 0.04412]

# -----------------------------------------------------------------------------
# LiDAR观测协方差 (LiDAR Measurement Covariance)
# -----------------------------------------------------------------------------
lidar_cov_inv: 1000.0              # LiDAR观测协方差的逆，值越大表示越信任LiDAR
                                   # 影响IMU和LiDAR融合时的权重分配

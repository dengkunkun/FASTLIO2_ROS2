# =============================================================================
# PGO (Pose Graph Optimization) Node 配置文件
# =============================================================================
# 功能：回环检测和位姿图优化节点，用于建图时消除累积漂移
# 工作流程：
#   1. 接收lio_node的点云和里程计
#   2. 基于位置先验+ICP检测回环
#   3. 使用GTSAM进行位姿图优化
# 输出：
#   - TF: map_frame → local_frame (优化后的变换)
#   - Topic: /pgo/loop_markers (回环可视化)
#   - Service: /pgo/save_maps (保存地图)
# =============================================================================

# -----------------------------------------------------------------------------
# 话题配置 (Topic Configuration)
# -----------------------------------------------------------------------------
cloud_topic: /fastlio2/body_cloud  # 输入点云话题
odom_topic: /fastlio2/lio_odom     # 输入里程计话题

# -----------------------------------------------------------------------------
# 坐标系配置 (Frame Configuration)
# -----------------------------------------------------------------------------
map_frame: map_camera_init         # 全局地图坐标系（优化后）
local_frame: camera_init           # 局部坐标系（里程计坐标系）

# -----------------------------------------------------------------------------
# TF 发布配置 (TF Broadcasting)
# -----------------------------------------------------------------------------
publish_tf: true                   # 是否发布 map_frame → local_frame TF
                                   # 在 remap_mode 下可设为 false，避免与 localizer TF 冲突

# -----------------------------------------------------------------------------
# 关键帧选择配置 (Keyframe Selection)
# -----------------------------------------------------------------------------
key_pose_delta_deg: 10             # 角度变化阈值(度)，超过此值添加关键帧
key_pose_delta_trans: 0.5          # 平移变化阈值(m)，超过此值添加关键帧
                                   # 两个条件满足任一即添加关键帧

# -----------------------------------------------------------------------------
# 回环检测配置 (Loop Detection)
# -----------------------------------------------------------------------------
loop_search_radius: 1.0            # 回环搜索半径(m)
                                   # 在此半径内搜索历史关键帧作为回环候选
loop_time_tresh: 60.0              # 回环时间阈值(s)
                                   # 只与超过此时间的历史帧进行回环检测
                                   # 避免与近期帧误匹配
loop_score_tresh: 0.15             # 回环ICP fitness score阈值
                                   # 小于此值认为回环有效
loop_submap_half_range: 5          # 子地图半范围（关键帧数）
                                   # 构建子地图时前后各取N个关键帧
submap_resolution: 0.1             # 子地图体素分辨率(m)
min_loop_detect_duration: 5.0      # 最小回环检测间隔(s)
                                   # 避免频繁回环检测影响性能

# =============================================================================
# 使用说明
# =============================================================================
# 1. 启动: ros2 launch pgo pgo_launch.py
# 2. 保存地图:
#    ros2 service call /pgo/save_maps interface/srv/SaveMaps \
#      "{file_path: '/path/to/save', save_patches: true}"
#    - save_patches=true: 同时保存分块点云，用于HBA优化
# =============================================================================